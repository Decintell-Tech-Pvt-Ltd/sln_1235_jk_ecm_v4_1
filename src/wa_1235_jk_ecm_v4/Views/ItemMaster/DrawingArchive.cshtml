@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@model wa_1235_jk_ecm_v4.Models.Master
@{
    ViewData["Title"] = "DrawingArchive";
    Layout = "~/Views/Shared/_ECMMaster.cshtml";
}
<div class="content-wrapper" style="min-height: 237.812px;">
   
    <section class="content-header">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-3">
                    <h5>Drawing Library</h5>
                </div>
                <div class="col-lg-9">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#" onclick="UserDetailChange('Index')">Home</a></li>
                        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">ECM</a></li>
                        <li class="breadcrumb-item"><a href="#">Archive</a></li>
                        <li class="breadcrumb-item active">Drawing Library</li>
                    </ol>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <div class="btnwidth50 float-right ">
                        <a id="btnBack" onClick="history.back()"
                           class="btn btn-block bg-gradient-danger btn-xs"
                           title="Go back to the previous page">
                            Back
                        </a>
                    </div>

                </div>
            </div>
        </div><!-- /.container-fluid -->

    </section>

    <section class="content">

        <div class="container-fluid">


			<!-- Drawing Master -->
			<div class="row">
				<div class="col-md-12">
					<div class="card card-outline card-primary">
					
						<div class="card-body">
							<div class="table-responsive">
								<table class="table table-bordered example1 nowrap" style="width:100%;">
									<thead>
										<tr>
											<th width="10%"><div align="center">Request No.</div></th>
											<th width="20%"><div align="center">Production SKU</div></th>
											<th width="20%"><div align="center">Drawing PDF</div></th>
											<th width="60%"><div align="left">Drawing Description</div></th>
										</tr>
									</thead>
									<tbody>
										@if (Model.Drawing_List != null)
										{
											foreach (var item in Model.Drawing_List)
											{
												if (item.GridNo == 3)
												{
													<tr>
														<td class="text-center">@item.RequestNo</td>
														<td class="text-center">@item.SKUKey</td>
														<td class="text-center">
															<button type="button"
																	class="btn btn-primary btn-xs"
																	onclick="OpenDocument('@item.SKUKey'+'.pdf')"
																	title="Download the file">
																Download
															</button>
														</td>
														<td class="text-left">@item.Description</td>
													</tr>
												}
											}
										}
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>

        </div>
    </section>


    <!-- InstanceEndEditable -->
</div>
<script>
	async function OpenDocument(FileName) {
		var JwToken = '@ViewBag.JWTToken';
		var url1 = '@ViewBag.ApiUrl';
		const apiUrl = url1 + 'UploadAndDownLoadFile/DownloadAsync';

		var Folder = 'drawings' + '\\';
		var path = Folder;

		const request = {
			FileName: path + FileName
		};

		try {
			const response = await fetch(apiUrl, {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
					Authorization: 'Bearer ' + JwToken
				},
				body: JSON.stringify(request),
			});

			if (!response.ok) {
				console.error("Network response was not ok");
				return;
			}

			// Open PDF in a new tab
			const blob = await response.blob();
			const objectURL = URL.createObjectURL(blob);

			// Open the object URL in a new tab
			const newTab = window.open(objectURL, '_blank');

			// Add a download button in the new tab
			if (newTab) {
				newTab.onload = () => {
					const downloadButton = newTab.document.createElement('a');
					downloadButton.href = objectURL;
					downloadButton.download = FileName; // Set the original file name
					downloadButton.innerText = "Download PDF";
					downloadButton.style.cssText = "position: fixed; top: 10px; right: 10px; background: #007bff; color: #fff; padding: 10px; text-decoration: none; border-radius: 5px;";
					newTab.document.body.appendChild(downloadButton);
				};
			}

			// Revoke the object URL after some time (optional cleanup)
			setTimeout(() => URL.revokeObjectURL(objectURL), 60000); // 60 seconds
		} catch (error) {
			console.error("Error:", error);
		}
	}
</script>